## 系统管理工具

`Linux`系统状态的查看及管理工具：`pstree`, `ps`, `pidof`, `pgrep`, `top`, `htop`, `glance`, `pmap`, `vmstat`, `dstat`, `kill`, `pkill`, `job`, `bg`, `fg`, `nohup`

### `pstree`命令

显示进程树

```bash
pstree [-acglpsStuZ] [ -h | -H PID ] [ -n | -N type ]
       [ -A | -G | -U ] [ PID | USER ]
pstree -V
```

显示子进程和进程号

```
[root@MyLinuxOPS ~]# pstree -ps
systemd(1)─┬─NetworkManager(704)─┬─{NetworkManager}(725)
           │                     └─{NetworkManager}(727)
           ├─agetty(788)
           ├─agetty(790)
           ├─auditd(661)───{auditd}(662)
           ├─chronyd(709)
           ├─crond(783)
           ├─dbus-daemon(689)
           ├─irqbalance(685)───{irqbalance}(711)
           ├─polkitd(703)─┬─{polkitd}(722)
           │              ├─{polkitd}(723)
           │              ├─{polkitd}(728)
           │              ├─{polkitd}(729)
           │              ├─{polkitd}(730)
           │              ├─{polkitd}(732)
           │              └─{polkitd}(775)
           ├─qemu-ga(721)
           ├─rngd(715)─┬─{rngd}(746)
           │           ├─{rngd}(747)
           │           ├─{rngd}(750)
           │           └─{rngd}(751)
           ├─rsyslogd(804)─┬─{rsyslogd}(830)
           │               └─{rsyslogd}(834)
           ├─sshd(745)───sshd(3561)───sshd(3575)───bash(3576)───pstree(3613)
           ├─sssd(702)─┬─sssd_be(766)
           │           └─sssd_nss(777)
           ├─systemd(3564)───(sd-pam)(3566)
           ├─systemd-journal(592)
           ├─systemd-logind(778)
           ├─systemd-udevd(624)
           └─tuned(742)─┬─{tuned}(1022)
                        ├─{tuned}(1024)
                        └─{tuned}(1030)
```

### `ps`命令

`ps`: report a snapshot of the current processes

`Linux`系统各进程的相关信息均保存在`/proc/PID`目录下的各文件中，`ps`命令可以将此目录下的内容直观的展现出来。

#### `ps`输出属性

`VSZ`: `Virtual memory SiZe`，虚拟内存集，线性内存

`RSS`: `ReSident Size`, 常驻内存集

`STAT`：进程状态

* `R`：`running`

* `S`: `interruptable sleeping`

* `D`: `uninterruptable sleeping` 
* `T`: `stopped`

* `Z`: `zombie`

* `+`: 前台进程
* `l`: 多线程进程

* `L`：内存分页并带锁

* `N`：低优先级进程

* `<`: 高优先级进程

* `s`: `session leader`，会话（子进程）发起者

#### `ps`命令格式：

```bash
ps [OPTION]...
```

`ps`命令支 持 三 种 选 项 ：

* UNIX选项 如-A -e 

* BSD选项 如a

* GNU选项  如--help

选项：

* 默认显示当前终端中的进程，其他终端的进程无法查看。

  ```bash
  [root@MyLinuxOPS ~]# ps
      PID TTY          TIME CMD
     3576 pts/0    00:00:00 bash
     3624 pts/0    00:00:00 ps
  ```


* `a`: 选项包括所有终端中的进程

  ```bash
  [root@MyLinuxOPS ~]# ps a
      PID TTY      STAT   TIME COMMAND
      788 tty1     Ss+    0:00 /sbin/agetty -o -p -- \u --noclear tty1 linux
      790 ttyS0    Ss+    0:00 /sbin/agetty -o -p -- \u --keep-baud 115200,38400,9600 ttyS0 vt220
     3576 pts/0    Ss     0:00 -bash
     3625 pts/0    R+     0:00 ps a
  ```

* `x`: 选项包括不链接终端的进程

  ```bash
  # x选项将显示所有和终端无关的进程，此处TTY为？表示没有终端
  [root@MyLinuxOPS ~]# ps x
      PID TTY      STAT   TIME COMMAND
        1 ?        Ss     0:04 /usr/lib/systemd/systemd --switched-root --system --deserialize 17
        2 ?        S      0:00 [kthreadd]
        3 ?        I<     0:00 [rcu_gp]
        4 ?        I<     0:00 [rcu_par_gp]
        6 ?        I<     0:00 [kworker/0:0H]
        8 ?        I      0:00 [kworker/u8:0-events_unbound]
  
  ```

* `u`: 选项显示进程所有者的信息

  ```bash
  # 加上u将显示出更多的内容，进程属主、cpu使用率、内存使用率、虚拟内存、实际使用内存、进程启动时间、进程累计占用的CPU时间。
  [root@MyLinuxOPS ~]# ps aux
  USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
  root           1  0.0  0.1 242336 10808 ?        Ss   Apr07   0:04 /usr/lib/systemd/systemd --switched-root --system --deserialize 17
  root           2  0.0  0.0      0     0 ?        S    Apr07   0:00 [kthreadd]
  root           3  0.0  0.0      0     0 ?        I<   Apr07   0:00 [rcu_gp]
  root           4  0.0  0.0      0     0 ?        I<   Apr07   0:00 [rcu_par_gp]
  root           6  0.0  0.0      0     0 ?        I<   Apr07   0:00 [kworker/0:0H]
  root           8  0.0  0.0      0     0 ?        I    Apr07   0:00 [kworker/u8:0-events_unbound]
  root           9  0.0  0.0      0     0 ?        I<   Apr07   0:00 [mm_percpu_wq]
  root          10  0.0  0.0      0     0 ?        S    Apr07   0:00 [ksoftirqd/0]
  ```

* `f`:  选项显示进程树,相当于 `--forest`

  ```bash
  # 类似于pstree可以显示进程树。
  [root@MyLinuxOPS ~]# ps auxf
  USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
  root         745  0.0  0.0  92292  7752 ?        Ss   Apr07   0:00 /usr/sbin/sshd -D -oCiphers=aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes256-cbc,aes12
  root        3561  0.0  0.1 163704 10528 ?        Ss   15:17   0:00  \_ sshd: root [priv]
  root        3575  0.0  0.0 163704  5764 ?        S    15:17   0:00      \_ sshd: root@pts/0
  root        3576  0.0  0.0  26984  4824 pts/0    Ss   15:17   0:00          \_ -bash
  root        3645  0.0  0.0  58860  4024 pts/0    R+   16:07   0:00              \_ ps auxf
  ```

* `k|--sort`:  属性 对属性排序,属性前加- 表示倒序

* `o`:  属性… 选项显示定制的信息 `pid`、`cmd`、`%cpu`、`%mem`
  
  * `L`: 显示o选项所支持的属性列表
  
    ```bash
    # ps L 输出的结果第一列为o选项的参数，第二列为ps输出时参数所对应的显示效果。
    [root@Computer01 ~]# ps L
    %cpu         %CPU
    %mem         %MEM
    _left        LLLLLLLL
    _left2       L2L2L2L2
    _right       RRRRRRRR
    ```
  
  * `ps`命令定制信息和输出排序
  
    ```bash
    # 光使用o没有用，还需要配合a和x来显示出和终端有关和无关的所有进程，然后使用o，输出需要关心的内容，k来指定排序的参数，默认从低到高排序
    [root@MyLinuxOPS ~]# ps axo pid,%mem,cmd k %mem
        745  0.0 /usr/sbin/sshd -D -oCiphers=aes256-gcm@openssh.com,chacha20-poly1305@openssh.com,aes256-ctr,aes256-cbc,aes128-gcm@openssh.com,aes128-ctr,aes128-cbc -oMACs=hmac-
        778  0.1 /usr/lib/systemd/systemd-logind
        804  0.1 /usr/sbin/rsyslogd -n
        624  0.1 /usr/lib/systemd/systemd-udevd
       3564  0.1 /usr/lib/systemd/systemd --user
        592  0.1 /usr/lib/systemd/systemd-journald
       3561  0.1 sshd: root [priv]
          1  0.1 /usr/lib/systemd/systemd --switched-root --system --deserialize 17
        702  0.1 /usr/sbin/sssd -i --logger=files
        766  0.1 /usr/libexec/sssd/sssd_be --domain implicit_files --uid 0 --gid 0 --logger=files
        704  0.2 /usr/sbin/NetworkManager --no-daemon
        703  0.3 /usr/lib/polkit-1/polkitd --no-debug
        742  0.3 /usr/libexec/platform-python -Es /usr/sbin/tuned -l -P
        777  0.5 /usr/libexec/sssd/sssd_nss --uid 0 --gid 0 --logger=files
    ```

* `-C cmdlist`: 指定命令，多个命令用，分隔

  ```bash
  # 查看指定命令的进程信息
  [root@MyLinuxOPS ~]# ps -C  bash
      PID TTY          TIME CMD
     3576 pts/0    00:00:00 bash
  ```

* `-L`: 显示线程

  ```bash
  # mysqld主进程中有多个线程。
  [root@MyLinuxOPS ~]# ps -L -C mysqld
      PID     LWP TTY          TIME CMD
     6269    6269 ?        00:00:00 mysqld
     6269    6272 ?        00:00:00 mysqld
     6269    6273 ?        00:00:00 mysqld
     6269    6274 ?        00:00:00 mysqld
     6269    6275 ?        00:00:00 mysqld
     6269    6276 ?        00:00:00 mysqld
     6269    6277 ?        00:00:00 mysqld
     6269    6278 ?        00:00:00 mysqld
     6269    6279 ?        00:00:00 mysqld
  ```

* `-e`: 显示所有进程，相当于`-A`

* `-f`: 显示完整格式程序信息

* `-F`: 显示更完整格式的进程信息

* `-H`: 以进程层级格式显示进程相关信息

* `-u userlist`: 指定有效的用户`ID`或名称，user或euser

* `-U userlist`: 指定真正的用户`ID`或名称，ruser

  ```bash
  # 在Masuri用户中执行passwd命令
  [root@MyLinuxOPS ~]# su Masuri
  [Masuri@MyLinuxOPS root]$ passwd
  Changing password for user Masuri.
  Current password:
  
  # root下查看passwd的user信息
  [root@MyLinuxOPS ~]# ps o pid,cmd,user,ruser,euser -C passwd
      PID CMD                         USER     RUSER    EUSER
     6408 passwd                      root     Masuri   root
     
  # ruser表示真正运行进程的用户。
  # user和euser表示生效的用户
  ```

* `-g gid`或`groupname`: 指定有效的`gid`或组名称

* `-G gid`或`groupname`: 指定真正的`gid`或组名称

* `-p pid`: 显示指`pid`的进程

* `--ppid pid`: 显示属于`pid`的子进程

* `-M`: 显示`SELinux`信息，相当于`Z`

* `ni`: nice值

  ```bash
  # nice值为-20到19，可以通过nice命令进行调整
  [root@MyLinuxOPS ~]# ps axo pid,cmd,user,ruser,euser,ni
      PID CMD                         USER     RUSER    EUSER     NI
   ...
       45 [khugepaged]                root     root     root      19
       46 [crypto]                    root     root     root     -20
       
  ```

* `pri`: priority 优先级

  ```bash
  # 查看实时优先级
  [root@MyLinuxOPS ~]# ps axo pid,cmd,user,ruser,euser,ni,pri
      PID CMD                         USER     RUSER    EUSER     NI PRI
     6442 ps axo pid,cmd,user,ruser,e root     root     root       0  19
  ```

* `psr`: processor CPU编号

*  `rtprio`: 实时优先级

  ```bash
  [root@MyLinuxOPS ~]# ps o pid,cmd,user,ruser,euser,ni,pri,rtprio  -C passwd
      PID CMD                         USER     RUSER    EUSER     NI PRI RTPRIO
     6444 passwd                      root     Masuri   root     -10  29      -
  # 有nice优先级将不会有实时优先级，所以RTPRIO为-
  
  # 调整实时优先级使用chrt，一般不调整实时优先级。
  ```


#### `ps`命令常用组合和示例

1. `ps -ef`

   ```bash
   # 会显示出父进程ID,C表示cpu利用率
   [root@MyLinuxOPS ~]# ps -ef
   UID          PID    PPID  C STIME TTY          TIME CMD
   root           1       0  0 Apr07 ?        00:00:05 /usr/lib/systemd/systemd --switched-root --system --deserialize 17
   root           2       0  0 Apr07 ?        00:00:00 [kthreadd]
   root           3       2  0 Apr07 ?        00:00:00 [rcu_gp]
   root           4       2  0 Apr07 ?        00:00:00 [rcu_par_gp]
   root           6       2  0 Apr07 ?        00:00:00 [kworker/0:0H]
   root           9       2  0 Apr07 ?        00:00:00 [mm_percpu_wq]
   ```

2. `ps -eFH`

3. ``

4. 查询你拥有的所有进程

   ```bash
   ps -x
   ```

   显示指定用户名(RUID)或用户ID的进程ps -fU apache

   ps -fU 48

   u 显示指定用户名(EUID)或用户ID的进程ps -fu wang

   ps -fu 1000

   u 查看以root用户权限（实际和有效ID）运行的每个进程ps -U root -u root

   u 列出某个组拥有的所有进程（实际组ID：RGID或名称） ps -fG nginx

   

   u 列出有效组名称（或会话）所拥有的所有进程ps -fg mysql

   ps -fg 27

   u 显示指定的进程ID对应的进程ps -fp 1234

   u 以父进程ID来显示其下所有的进程，如显示父进程为1234的所有进程ps -f --ppid 1234

   u 显示指定PID的多个进程

   ps -fp 1204,1239,1263

   u 要按tty显示所属进程ps -ft pts/0

   

   u 以进程树显示系统中的进程如何相互链接ps -e --forest

   u 以进程树显示指定的进程ps -f --forest -C sshd

   ps -ef --forest | grep -v grep | grep sshd

   u 要显示一个进程的所有线程,将显示LWP（轻量级进程）以及NLWP（轻量级进程数）列

   ps -fL -C nginx

   u 要列出所有格式说明符ps L

   u 查看进程的PID，PPID，用户名和命令

   ps -eo pid,ppid,user,cmd

   

   u 自定义格式显示文件系统组,ni值开始时间和进程的时间ps -p 1234 -o pid,ppid,fgroup,ni,lstart,etime

   u 使用其PID查找进程名称： ps -p 1244 -o comm=

   u 要以其名称选择特定进程，显示其所有子进程

   ps -C sshd,bash

   u 查找指定进程名所有的所属PID，在编写需要从std输出或文件读取PID的脚本时这个参数很有用

   ps -C httpd,sshd -o pid=

   u 检查一个进程的执行时间

   ps -eo comm,etime,user | grep nginx

   

   u 查找占用最多内存和CPU的进程

   ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head

   ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%cpu | head

   u 显示安全信息ps -eM

   ps --context

   u 使用以下命令以用户定义的格式显示安全信息ps -eo euser,ruser,suser,fuser,f,comm,label

   u 使用watch实用程序执行重复的输出以实现对就程进行实时的监视，如下面的命令显示每秒钟的监视

   watch -n 1 'ps -eo pid,ppid,cmd,%mem,%cpu --sort=-%mem | head'

   

   u 进程优先级调整

   静态优先级：100-139

   进程默认启动时的nice值为0，优先级为120 只有根用户才能降低nice值（提高优先性）

   u nice命令

   nice [OPTION] [COMMAND [ARG]...]

   u renice命令

   renice [-n] priority pid...

   u 查看

   ps axo pid,comm,ni

### `nice`和`renice`命令

#### `nice`命令

调整程序运行时的nice值，命令格式如下：

```bash
nice [OPTION] [COMMAND [ARG]...]
```

参数：

* `-n`: 指定`nice`值

示例：

```bash
# 指定命令运行时的nice值
[root@MyLinuxOPS ~]# nice -n -5  tail -f /etc/passwd
tss:x:59:59:Account used by the trousers package to sandbox the tcsd daemon:/dev/null:/sbin/nologin
polkitd:x:998:996:User for polkitd:/:/sbin/nologin

# 查看下tail命令的nice值
[Masuri@MyLinuxOPS root]$ ps o pid,cmd,user,euser,ruser,ni,pri -C tail
    PID CMD                         USER     EUSER    RUSER     NI PRI
   6479 tail -f /etc/passwd         root     root     root      -5  24
```

#### `renice`命令

动态调整正在运行的命令的`nice`值，命令格式如下：

```bash
 renice [-n] priority [-g|-p|-u] identifier...
```

示例：

```bash
# 查看实时优先级
[root@MyLinuxOPS ~]# ps axo pid,cmd,user,ruser,euser,ni,pri
    PID CMD                         USER     RUSER    EUSER     NI PRI
   6442 ps axo pid,cmd,user,ruser,e root     root     root       0  19

# 对pri优先级做修改
[root@MyLinuxOPS ~]# renice -10 6444
6444 (process ID) old priority 0, new priority -10
[root@MyLinuxOPS ~]# ps o pid,cmd,user,ruser,euser,ni,pri  -C passwd
    PID CMD                         USER     RUSER    EUSER     NI PRI
   6444 passwd                      root     Masuri   root     -10  29
# pri优先级值越大优先级越高
# nice值越低优先级越高
```

