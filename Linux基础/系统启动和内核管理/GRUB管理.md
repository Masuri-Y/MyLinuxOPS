## GRUB管理

`grub`: `GRand Unified Bootloader`

* `grub 0.97`: `grub legacy` 
* `grub 2.x`: `grub2`

* `grub legacy`:
  * `stage1`: `mbr`
  * `stage1_5`: `mbr`之后的扇区，让`stage1`中的`bootloader`能识别`stage2`所在的分区上的文件系统
  * `stage2`: 磁盘分区(`/boot/grub/`)

一旦`GRUB`被破坏，系统将直接无法启动，略过系统磁盘分区，直接去寻找下一个拥有启动功能的设备。

#### `GRUB legacy`修复

`GRUB`修复命令有2个，`grub-install`和交互式的`grub`命令

(1) `grub-install`

安装`grub stage1`和`stage1.5`到`/dev/DISK`磁盘上，并复制`GRUB`相关文件到`DIR/boot`目录下

```bash
grub-install --root-directory=DIR /dev/DISK
# DIR为boot文件夹所在的目录，如果路径为/boot，则可以省略，如果不是则需要指定boot目录所在的文件夹的上级目录。
# /dev/DISK为所要修复的磁盘,如/dev/sda
```

(2) `grub`交互式

```bash
bash-4.1# grub
grub> root (hd#,#)  
# 指定boot所在的目录。第一个#表示boot所在的磁盘，第二个#表示boot所在的分区
# root (hd0,0) hd表示硬盘,0表示第一个硬盘，0表示第一个分区。
grub> setup (hd#)
# setup (hd0) 表示将grub安装在第一个硬盘上。

# GRUB安装完毕后退出
grub> exit

# 注意接下来需要强制同步。如果不写入磁盘可能数据还在缓冲区，直接重启可能依旧失败。
bash-4.1# sync
bash-4.1# sync

```

注意：`grub`交互式的修复是依赖于`/boot/grub`目录下的备份文件的，如果该目录下的文件不存在，将无法进行修复。这时候只能使用`grub-install`命令来进行修复.

#### `grub.conf`文件

`grub.conf`文件内定义了，`grub1`阶段启动后，操作系统去什么位置找内核文件，如果此文件丢失，光修复了`grub1`阶段系统依旧无法启动。

```bash
[root@mylinuxops ~]# vim /boot/grub/grub.conf 
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /boot/, eg.
#          root (hd0,0)
#          kernel /vmlinuz-version ro root=/dev/vda2
#          initrd /initrd-[generic-]version.img
#boot=/dev/vda
default=0  # 表示默认启动菜单，如果有多个启动菜单0表示默认选择第一个
timeout=5  # 表示默认多长时间不选择菜单则选择第一个菜单。
splashimage=(hd0,0)/grub/splash.xpm.gz  # 表示的是运行出现的GRUB背景的path。
password mylinuxops  # 为grub添加密码，无密码将无法破解root口令。
# password --md5 $1$****  此处不建议明文，建议使用grub-md5-crypt加密后放入。

hiddenmenu # 表示隐藏GRUB的启动菜单，直接进入由default描述的操作系统中
serial --unit=0 --speed=9600
terminal --timeout=5 serial console
title CentOS (2.6.32-573.8.1.el6.x86_64)
        root (hd0,0)  # 此行表示boot所在的硬盘和分区
        kernel /vmlinuz-2.6.32-573.8.1.el6.x86_64 ro root=UUID=30780f67-b337-48c1-aa58-79e0f2038043 rd_NO_LUKS  KEYBOARDTYPE=pc KEYTABLE=us LANG=en_US.UTF-8 rd_NO_MD SYSFONT=latarcyrheb-sun16 console=ttyS0 rd_NO_LVM crashkernel=auto rhgb quiet rd_NO_DM 
# 此行为kernel所在的路径，其中/表示的为boot分区的根，grub认为boot才是操作系统的根目录
# root=UUID=30780f67-b337-48c1-aa58-79e0f2038043，此参数为指定操作系统的/。
		initrd /initramfs-2.6.32-573.8.1.el6.x86_64.img  # 此行表示的是虚拟文件系统文件所在的位置
title CentOS 6 (2.6.32-573.el6.x86_64)

```

此文件中需要注意，内核必须先于`initrd`被加载，否则无法启动。